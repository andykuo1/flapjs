!function(t){var e={};function s(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:i})},s.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);var i={__events:new Map,addListener(t,e){this.__events.has(t)||this.__events.set(t,[]),this.__events.get(t).push(e)},removeListener(t,e){if(!this.__events.has(t))return;const s=this.__events.get(t);s.splice(s.indexOf(e),1)},clearListeners(t){if(!this.__events.has(t))return;this.__events.get(t).length=0},countListeners(t){return this.__events.has(t)?this.__events.get(t).length:0},getListeners(t){return this.__events.get(t)},emit(t){if(!this.__events.has(t))return;const e=Array.prototype.splice.call(arguments,1),s=this.__events.get(t),i=s.length;let o=0;for(;o<i;){s[o].apply(null,e)?(s.splice(o,1),--o):++o}this.onEventProcessed(t,e)},on(t,e){this.addListener(t,e)},once(t,e){this.addListener(t,()=>(e(),!0))},onEventProcessed(t,e){}};const o=!0;class r{constructor(t,e){this.x=0,this.y=0,this.scrollX=0,this.scrollY=0,this._viewport=t,this._element=e,this._mouseup=this.onMouseUp.bind(this),this._mousedown=this.onMouseDown.bind(this),this._mouseclick=this.onMouseClick.bind(this),this._wheel=this.onMouseWheel.bind(this),this._mousemove=this.onMouseMove.bind(this),this._mouseenter=this.onMouseEnter.bind(this),this._mouseexit=this.onMouseExit.bind(this),this._touchstart=this.onTouchStart.bind(this),this._touchmove=this.onTouchMove.bind(this),this._touchstop=this.onTouchStop.bind(this),this._contextmenu=(t=>!o||(t.preventDefault(),!1)),this._viewport.addEventListener("contextmenu",this._contextmenu,!1),this._viewport.addEventListener("mouseup",this._mouseup),this._viewport.addEventListener("mousedown",this._mousedown),this._viewport.addEventListener("click",this._mouseclick),this._viewport.addEventListener("wheel",this._wheel),this._element.addEventListener("mousemove",this._mousemove),this._viewport.addEventListener("mouseenter",this._mouseenter),this._viewport.addEventListener("mouseleave",this._mouseexit),this._viewport.addEventListener("touchstart",this._touchstart)}destroy(){this._viewport.removeEventListener("contextmenu",this._contextmenu),this._viewport.removeEventListener("mouseup",this._mouseup),this._viewport.removeEventListener("mousedown",this._mousedown),this._viewport.removeEventListener("click",this._mouseclick),this._viewport.removeEventListener("wheel",this._wheel),this._element.removeEventListener("mousemove",this._mousemove),this._viewport.removeEventListener("mouseenter",this._mouseenter),this._viewport.removeEventListener("mouseleave",this._mouseexit),this._viewport.removeEventListener("touchstart",this._touchstart)}onMouseUp(t){this.onMouseMove(t),this.emit("mouseup",this,t.which)}onMouseDown(t){this.onMouseMove(t),this.emit("mousedown",this,t.which)}onMouseClick(t){this.onMouseMove(t),this.emit("mouseclick",this,t.which)}onMouseWheel(t){this.scrollX+=t.deltaX,this.scrollY+=t.deltaY,this.emit("mousewheel",this,t.deltaX,t.deltaY)}onMouseMove(t){const e=this._viewport.getBoundingClientRect();this.x=t.clientX-e.left,this.y=t.clientY-e.top,this.emit("mousemove",this,this.x,this.y)}onMouseEnter(t){this.emit("mouseenter",this)}onMouseExit(t){this.emit("mouseexit",this)}onTouchStart(t){const e=t.touches[0].target;e.addEventListener("touchmove",this._touchmove),e.addEventListener("touchend",this._touchstop),e.addEventListener("touchcancel",this._touchstop)}onTouchStop(t){const e=t.touches[0].target;e.removeEventListener("touchmove",this._touchmove),e.removeEventListener("touchend",this._touchstop),e.removeEventListener("touchcancel",this._touchstop)}onTouchMove(t){this.onMouseMove(t.touches[0])}}r.BUTTON_LEFT=0,r.BUTTON_MIDDLE=1,r.BUTTON_RIGHT=2,Object.assign(r.prototype,i);var n=r;class h{constructor(t){this.nodes=[],this.edges=[],this.viewport=t,this._offsetX=0,this._offsetY=0,this.nextOffsetX=0,this.nextOffsetY=0}get centerX(){return this.viewport.width/2+this._offsetX}get centerY(){return this.viewport.height/2+this._offsetY}get offsetX(){return this._offsetX}get offsetY(){return this._offsetY}set offsetX(t){this.nextOffsetX=t}set offsetY(t){this.nextOffsetY=t}createNewNode(t,e,s){const i=new a(this,t,e,s);return 0==this.nodes.length&&this.emit("newInitial",i,null),this.nodes.push(i),this.emit("nodeCreate",i),i}destroyNode(t){let e=null;for(let s=this.edges.length-1;s>=0;--s)(e=this.edges[s]).from==t?(this.edges.splice(s,1),this.emit("edgeDestroy",e)):e.to==t&&e.makePlaceholder();let s=this.nodes.indexOf(t);this.nodes.splice(s,1),0==s&&this.emit("newInitial",this.getInitialState(),t),this.emit("nodeDestroy",t)}createNewEdge(t,e,s){const i=new l(this,t,e,s);return i.isSelfLoop()&&(i.y=t.y-SELF_LOOP_HEIGHT),this.edges.push(i),this.emit("edgeCreate",i),i}destroyEdge(t){this.edges.splice(this.edges.indexOf(t),1),this.emit("edgeDestroy",t)}clear(){for(let t of this.nodes)this.emit("nodeDestroy",t);this.nodes.length=0;for(let t of this.edges)this.emit("edgeDestroy",t);this.edges.length=0}update(t){this._offsetX=c(this._offsetX,this.nextOffsetX,t),this._offsetY=c(this._offsetY,this.nextOffsetY,t);for(const e of this.nodes)e.update(t)}setInitialState(t){if(this.nodes.length<=1)return;this.nodes.splice(this.nodes.indexOf(t),1);const e=this.nodes[0];this.nodes.unshift(t),this.emit("newInitial",t,e)}toggleAcceptState(t){t.accept=!t.accept}getInitialState(){return this.nodes.length>0?this.nodes[0]:null}}Object.assign(h.prototype,i);class a{constructor(t,e=0,s=0,i="q"){this.graph=t,this._x=e,this._y=s,this.nextX=e,this.nextY=s,this._label=i,this._accept=!1}get x(){return this._x+this.graph.centerX}get y(){return this._y+this.graph.centerY}set x(t){this.nextX=t}set y(t){this.nextY=t}get label(){return this._label}set label(t){let e=this._label;this._label=t,this.graph.emit("nodeLabel",this,this._label,e)}get accept(){return this._accept}set accept(t){let e=this._accept;this._accept=t,this.graph.emit("toggleAccept",this,this._accept,e)}update(t){this._x=c(this._x,this.nextX,t),this._y=c(this._y,this.nextY,t)}}class l{constructor(t,e,s,i="#"){this.graph=t,this._label=i,this._from=e,this._to=s,this.quad=null}getStartPoint(){if(null==this.quad){const t=this.from.x-this.to.x,e=this.from.y-this.to.y,s=-Math.atan2(e,t)-HALF_PI,i=NODE_RADIUS*Math.sin(s),o=NODE_RADIUS*Math.cos(s);return[this.from.x+i,this.from.y+o]}{const t=this.getMidPoint(),e=t[0]+2*this.quad.x,s=t[1]+2*this.quad.y,i=this.from.x-e,o=this.from.y-s,r=-Math.atan2(o,i)-HALF_PI+(this.isSelfLoop()?FOURTH_PI:0),n=NODE_RADIUS*Math.sin(r),h=NODE_RADIUS*Math.cos(r),a=t;return a[0]=this.from.x+n,a[1]=this.from.y+h,a}}getCenterPoint(){const t=this.getMidPoint();return null!=this.quad&&(t[0]+=this.quad.x,t[1]+=this.quad.y),t}getEndPoint(){if(null==this.quad){const t=this.isPlaceholder()?1:NODE_RADIUS,e=this.from.x-this.to.x,s=this.from.y-this.to.y,i=-Math.atan2(s,e)-HALF_PI,o=t*Math.sin(i),r=t*Math.cos(i);return[this.to.x-o,this.to.y-r]}{const t=this.getMidPoint(),e=t[0]+2*this.quad.x,s=t[1]+2*this.quad.y,i=e-this.to.x,o=s-this.to.y,r=-Math.atan2(o,i)-HALF_PI+(this.isSelfLoop()?-FOURTH_PI:0),n=NODE_RADIUS*Math.sin(r),h=NODE_RADIUS*Math.cos(r),a=t;return a[0]=this.to.x-n,a[1]=this.to.y-h,a}}getMidPoint(){return[this.from.x+(this.to.x-this.from.x)/2,this.from.y+(this.to.y-this.from.y)/2]}get centerX(){return this.from.x+(this.to.x-this.from.x)/2}get centerY(){return this.from.y+(this.to.y-this.from.y)/2}get x(){const t=this.centerX;return null!=this.quad?this.quad.x+t:t}get y(){const t=this.centerY;return null!=this.quad?this.quad.y+t:t}set x(t){null==this.quad&&(this.quad={x:0,y:0}),this.quad.x=t-this.centerX,Math.abs(this.quad.x)<8&&(this.quad.x=0),0==this.quad.x&&0==this.quad.y&&(this.quad=null)}set y(t){null==this.quad&&(this.quad={x:0,y:0}),this.quad.y=t-this.centerY,Math.abs(this.quad.y)<8&&(this.quad.y=0),0==this.quad.x&&0==this.quad.y&&(this.quad=null)}get label(){return this._label}set label(t){let e=this._label;this._label=t,this.graph.emit("edgeLabel",this,this._label,e)}get from(){return this._from}get to(){return this._to}set to(t){let e=this._to;this._to=t,this.graph.emit("edgeDestination",this,this._to,e)}makePlaceholder(){this.to||(this.to={x:this.from.x+1,y:this.from.y});const t=this.from.x-this.to.x,e=this.from.y-this.to.y,s=-Math.atan2(t,e)-HALF_PI;this.to={from:this.from,dx:Math.cos(s),dy:Math.sin(s),get x(){return this.from.x+PLACEHOLDER_LENGTH*this.dx},get y(){return this.from.y+PLACEHOLDER_LENGTH*this.dy}},this.quad=null}isSelfLoop(){return this.from==this.to}isPlaceholder(){return!(this.to instanceof a)}}function c(t,e,s){return t*(1-s)+e*s}var u=class{constructor(){this.element=document.getElementById("label-editor"),this.inputElement=document.getElementById("label-editor-input"),this.inputElement.addEventListener("keyup",t=>{t.keyCode==SUBMIT_KEY?this.close(!0):t.keyCode==CLEAR_KEY&&this.close(!1)}),this.inputElement.addEventListener("blur",t=>{this.close(!1)}),this.target=null}open(t,e=null){return this.target!=t&&(this.target=t,this.element.style.left=this.target.x-this.element.offsetWidth/2+"px",this.element.style.top=this.target.y-this.element.offsetHeight/2+"px",this.inputElement.value=e||this.target.label,this.element.style.visibility="visible",this.inputElement.focus(),this.inputElement.select(),!0)}close(t=!1){return null!=this.target&&(t&&(this.target.label=this.inputElement.value),this.target=null,this.element.style.visibility="hidden",!0)}isOpen(){return null!=this.target}isEditting(t){return this.target==t}};var g=class{constructor(t,e){this.graph=t,this.mouse=e}getNodesWithin(t,e,s,i,o){for(const r of this.graph.nodes)r.x>=t&&r.x<s&&r.y>=e&&r.y<i&&o.push(r)}getNodeAt(t,e){for(const s of this.graph.nodes){const i=t-s.x,o=e-s.y;if(i*i+o*o<NODE_RADIUS_SQU)return s}return null}getEdgeAt(t,e){for(const s of this.graph.edges){const i=t-s.x,o=e-s.y;if(i*i+o*o<EDGE_RADIUS_SQU)return s}return null}getEdgeByEndPointAt(t,e){for(const s of this.graph.edges){const i=s.getEndPoint(),o=t-i[0],r=e-i[1];if(o*o+r*r<ENDPOINT_RADIUS_SQU)return s}return null}};var d=class{constructor(t){this.graph=t}onSingleTap(t,e,s,i,o){return!1}onDoubleTap(t,e,s,i,o){return!1}onStartDragging(t,e,s,i,o){return!1}onDragging(t,e,s,i,o){return!1}onStopDragging(t,e,s,i,o){return!1}};var p=class extends d{constructor(t,e){super(e),this.mainController=t}onSingleTap(t,e,s,i,o){return"node"==o?(this.graph.toggleAcceptState(i),!0):"edge"==o&&(this.mainController.openLabelEditor(i),!0)}onDoubleTap(t,e,s,i,o){return null==i&&(this.mainController.createNewState(e-this.graph.centerX,s-this.graph.centerY),!0)}onStartDragging(t,e,s,i,o){if("node"==o){const t=this.mainController.createNewTransition(i,null,STR_TRANSITION_PROXY_LABEL);return this.mainController.startMove(t,"endpoint"),!0}return!1}};var m=class extends d{constructor(t,e){super(e),this.mainController=t,this.prevTarget={x:0,y:0},this.graphTarget={x:0,y:0},this.quadTarget={x:0,y:0}}onStartDragging(t,e,s,i,o){if(null!=i){if("edge"==o&&console.log(i.isPlaceholder()+", "+o),"edge"==o&&i.isPlaceholder())return this.mainController.stopMove(),!1;this.prevTarget.x=e,this.prevTarget.y=s,this.mainController.startMove(i,o)}else this.graphTarget.x=e,this.graphTarget.y=s,this.mainController.startMove(this.graphTarget,"graph");return!0}onDragging(t,e,s,i,o){return null!=i&&(this.moveTarget(t,i,o,e,s),!0)}onStopDragging(t,e,s,i,o){let r=!1;if(null!=i){if(r=this.moveTarget(t,i,o,e,s),"endpoint"==o)return r?i.label==STR_TRANSITION_PROXY_LABEL&&(i.label=STR_TRANSITION_DEFAULT_LABEL,this.mainController.openLabelEditor(i)):this.mainController.shouldDestroyPointlessEdges?this.graph.destroyEdge(i):this.mainController.isWithinTrash(e,s)?this.graph.destroyEdge(i):(i.makePlaceholder(),i.label==STR_TRANSITION_PROXY_LABEL&&(i.label=STR_TRANSITION_DEFAULT_LABEL,this.mainController.openLabelEditor(i))),!0;if("node"==o&&this.mainController.isWithinTrash(e,s)){if(this.mainController.selectCursor.hasSelection()){for(const t of this.mainController.selectCursor.getSelection())this.graph.destroyNode(t);this.mainController.selectCursor.clearSelection()}else this.graph.destroyNode(i);return!0}}else r=this.moveTarget(t,this.graphTarget,"graph",e,s);return r}moveTarget(t,e,s,i,o){if(null==e)throw new Error("Trying to resolve target mode '"+s+"' with missing target source");if("node"==s){if(this.mainController.selectCursor.hasSelection()){const t=i-this.prevTarget.x,e=o-this.prevTarget.y;for(const s of this.mainController.selectCursor.getSelection())s.nextX+=t,s.nextY+=e;this.prevTarget.x=i,this.prevTarget.y=o}else e.x=i-this.graph.centerX,e.y=o-this.graph.centerY;return!0}if("edge"==s)return e.x=i,e.y=o,!0;if("endpoint"==s){let s=!0;const r=t.getNodeAt(i,o);if(r?(e.to=r,s=!0):(e.to=t.mouse,s=!1),e.isSelfLoop()){const t=e.from.x-i,s=e.from.y-o,r=Math.atan2(s,t);e.x=e.from.x-Math.cos(r)*SELF_LOOP_HEIGHT,e.y=e.from.y-Math.sin(r)*SELF_LOOP_HEIGHT}else 0!=this.quadTarget.x||0!=this.quadTarget.y?(e.x=e.y=1,e.quad.x=this.quadTarget.x,e.quad.y=this.quadTarget.y):e.quad=null;return s}return"graph"==s&&(this.graph.offsetX=i-e.x,this.graph.offsetY=o-e.y,!0)}};var _=class extends d{constructor(t,e){super(e),this.mainController=t,this.selectBox={x:0,y:0,mx:0,my:0,targets:[]},this.isSelecting=!1}onStartDragging(t,e,s,i,o){return null==i&&(this.isSelecting=!0,this.selectBox.x=e,this.selectBox.y=s,this.selectBox.mx=e,this.selectBox.my=s,this.clearSelection(),!0)}onDragging(t,e,s,i,o){return!!this.isSelecting&&(this.selectBox.mx=e,this.selectBox.my=s,this.getSelection(t),!0)}onStopDragging(t,e,s,i,o){return!!this.isSelecting&&(this.selectBox.mx=e,this.selectBox.my=s,this.getSelection(t),this.isSelecting=!1,!0)}getSelection(t){if(this.isSelecting){const e=Math.max(this.selectBox.mx,this.selectBox.x),s=Math.max(this.selectBox.my,this.selectBox.y),i=Math.min(this.selectBox.mx,this.selectBox.x),o=Math.min(this.selectBox.my,this.selectBox.y);this.clearSelection(),t.getNodesWithin(i,o,e,s,this.selectBox.targets)}return this.selectBox.targets}hasSelection(){return this.selectBox.targets.length>0}clearSelection(){this.selectBox.targets.length=0}};var E=class{constructor(t,e){this.graph=t,this.mouse=e,this.cursor=new g(t,e),this.labelEditor=new u,this.editCursor=new p(this,this.graph),this.moveCursor=new m(this,this.graph),this.selectCursor=new _(this,this.graph),this.moveMode=!1,this.tap={x:0,y:0},this.doubleTapTicks=0,this.isDown=!1,this.isDragging=!1,this.target=null,this.targetType=null,this.hoverTarget=null,this.hoverType=null,this.shouldDestroyPointlessEdges=DEFAULT_SHOULD_DESTROY_POINTLESS_EDGE,this.trashArea={x:TRASH_AREA_POSX,y:TRASH_AREA_POSY,width:TRASH_AREA_WIDTH,height:TRASH_AREA_HEIGHT}}load(){this.mouse.on("mousedown",this.onMouseDown.bind(this)),this.mouse.on("mouseup",this.onMouseUp.bind(this)),this.mouse.on("mouseexit",this.onMouseExit.bind(this)),this.mouse.on("mousemove",this.onMouseMove.bind(this))}update(t){this.doubleTapTicks>0&&--this.doubleTapTicks;const e=this.mouse.x,s=this.mouse.y;this.hoverTarget=null,(this.hoverTarget=this.target)?(this.hoverTarget=this.target,this.hoverType=this.targetType):(this.hoverTarget=this.cursor.getNodeAt(e,s))?this.hoverType="node":(this.hoverTarget=this.cursor.getEdgeAt(e,s))?this.hoverType="edge":(this.hoverTarget=this.cursor.getEdgeByEndPointAt(e,s))&&(this.hoverType="endpoint")}onMouseDown(t,e){this.moveMode=3==e;const s=this.tap.x=t.x,i=this.tap.y=t.y;this.isDown=!0,this.isDragging=!1,(this.target=this.cursor.getNodeAt(s,i))?this.targetType="node":(this.target=this.cursor.getEdgeAt(s,i))?this.targetType="edge":(this.target=this.cursor.getEdgeByEndPointAt(s,i))?this.targetType="endpoint":(this.target=null,this.targetType=null),this.selectCursor.hasSelection()&&("node"==this.targetType&&this.selectCursor.selectBox.targets.includes(this.target)||this.selectCursor.clearSelection())}onMouseUp(t,e){const s=t.x,i=t.y;this.isDown=!1,this.isDragging?(this.doStopDragging(s,i),this.isDragging=!1):this.doubleTapTicks>0?this.doDoubleTap(s,i)||this.doSingleTap(s,i):(this.doSingleTap(s,i),this.doubleTapTicks=DOUBLE_TAP_TICKS),this.target=null,this.targetType=null}onMouseMove(t,e,s){if(this.isDragging)return void this.doDragging(e,s);if(!this.isDown)return;let i=this.tap.x,o=this.tap.y,r=CURSOR_RADIUS_SQU;if(null!=this.target)if("node"==this.targetType)i=this.target.x,o=this.target.y,r=NODE_RADIUS_SQU;else if("edge"==this.targetType)i=this.target.x,o=this.target.y,r=EDGE_RADIUS_SQU;else if("endpoint"==this.targetType){const t=this.target.getEndPoint();i=t[0],o=t[1],r=ENDPOINT_RADIUS_SQU}(i-=e)*i+(o-=s)*o>=r&&(this.isDragging=!0,this.doStartDragging(e,s))}onMouseExit(t){const e=t.x,s=t.y;this.isDragging&&(this.doStopDragging(e,s),this.isDragging=!1),this.isDown&&(this.onMouseUp(t,0),this.isDown=!1)}doSingleTap(t,e){return this.moveMode?this.moveCursor.onSingleTap(this.cursor,t,e,this.target,this.targetType):this.editCursor.onSingleTap(this.cursor,t,e,this.target,this.targetType)||this.selectCursor.onSingleTap(this.cursor,t,e,this.target,this.targetType)}doDoubleTap(t,e){return this.moveMode?this.moveCursor.onDoubleTap(this.cursor,t,e,this.target,this.targetType):this.editCursor.onDoubleTap(this.cursor,t,e,this.target,this.targetType)||this.selectCursor.onDoubleTap(this.cursor,t,e,this.target,this.targetType)}doStartDragging(t,e){return this.moveMode?this.moveCursor.onStartDragging(this.cursor,t,e,this.target,this.targetType):this.editCursor.onStartDragging(this.cursor,t,e,this.target,this.targetType)||this.selectCursor.onStartDragging(this.cursor,t,e,this.target,this.targetType)}doDragging(t,e){return this.moveMode?this.moveCursor.onDragging(this.cursor,t,e,this.target,this.targetType):this.editCursor.onDragging(this.cursor,t,e,this.target,this.targetType)||this.selectCursor.onDragging(this.cursor,t,e,this.target,this.targetType)}doStopDragging(t,e){return this.moveMode?this.moveCursor.onStopDragging(this.cursor,t,e,this.target,this.targetType):this.editCursor.onStopDragging(this.cursor,t,e,this.target,this.targetType)||this.selectCursor.onStopDragging(this.cursor,t,e,this.target,this.targetType)}createNewState(t,e){const s=this.graph.createNewNode(t,e,STR_STATE_LABEL+this.graph.nodes.length);return s.x=t||Math.random()*SPAWN_RADIUS*2-SPAWN_RADIUS,s.y=e||Math.random()*SPAWN_RADIUS*2-SPAWN_RADIUS,s}createNewTransition(t,e,s=STR_TRANSITION_DEFAULT_LABEL){return this.graph.createNewEdge(t,e,s)}openLabelEditor(t,e=null){this.labelEditor.open(t,e)}startMove(t,e){if(this.moveMode=!0,this.target=t,this.targetType=e,"endpoint"==this.targetType){const t=this.target.quad;null!=t?(this.moveCursor.quadTarget.x=t.x,this.moveCursor.quadTarget.y=t.y):(this.moveCursor.quadTarget.x=0,this.moveCursor.quadTarget.y=0)}this.moveCursor.moveTarget(this.cursor,this.target,this.targetType,this.mouse.x,this.mouse.y)}stopMove(){this.moveMode=!1}isWithinTrash(t,e){const s=t-this.trashArea.x,i=e-this.trashArea.y;return s>0&&s<this.trashArea.width&&i>0&&i<this.trashArea.height}};var f=new class{constructor(){this._simulatePhysics=!1}sort(){this._simulatePhysics=!0}update(t,e){if(this._simulatePhysics){let t=!1;for(const s of e.nodes)for(const i of e.nodes){if(s==i)continue;const e=s.nextX-i.nextX,o=s.nextY-i.nextY;e*e+o*o<PADDING_RADIUS_SQU&&(s.nextX+=.5*e,s.nextY+=.5*o,t=!0)}this._simulatePhysics=t}}};var S=class{constructor(t,e,s){this.viewport=t,this.graph=e,this.cursorController=s}load(){document.getElementById("new_state").addEventListener("click",t=>{this.cursorController.createNewState()}),document.getElementById("clear_graph").addEventListener("click",t=>{this.graph.clear()}),document.getElementById("simulate_physics").addEventListener("click",t=>{f.sort()}),document.getElementById("export_image").addEventListener("click",t=>{if(this.viewport instanceof HTMLImageElement){const t=this.viewport.toDataURL("image/png");download(t,EXPORT_FILE_NAME,"image/png")}})}update(t){f.update(t,this.graph)}};var T=class{constructor(t){this.graph=t,this.statesElement=document.getElementById("states"),this.symbolsElement=document.getElementById("symbols"),this.transitionsElement=document.getElementById("transitions"),this.startStateElement=document.getElementById("startState"),this.finalStatesElement=document.getElementById("finalStates"),this.states=[],this.symbols=[],this.graph.on("nodeCreate",this.onNode.bind(this)),this.graph.on("nodeDestroy",this.onNode.bind(this)),this.graph.on("nodeLabel",this.onNode.bind(this)),this.graph.on("edgeCreate",this.onEdge.bind(this)),this.graph.on("edgeDestroy",this.onEdge.bind(this)),this.graph.on("edgeLabel",this.onEdge.bind(this)),this.graph.on("edgeDestination",this.onEdgeDestination.bind(this)),this.graph.on("newInitial",this.onNewInitial.bind(this)),this.graph.on("toggleAccept",this.onToggleAccept.bind(this))}evaluateStates(){let t=[];for(const e of this.graph.nodes)e.label&&t.push(e.label);t.sort(),this.statesElement.innerText=t.join(", ")}evaluateSymbols(){let t=[];for(const e of this.graph.edges){if(!e.label)continue;const s=e.label.split(" ");for(const e of s)t.includes(e)||t.push(e)}t.sort(),this.symbolsElement.innerText=t.join(", ")}evaluateTransitions(){let t=[];for(const e of this.graph.edges){if(!e.label)continue;const s=e.label.split(" ");for(const i of s){const s=e.from?e.from.label:"undefined",o=e.to?e.to.label:"undefined";t.push("<li>("+s+", "+i+") &rarr; "+o)}}t.sort(),this.transitionsElement.innerHTML=t.join(",</li>")}evaluateStartState(){const t=this.graph.getInitialState();this.startStateElement.innerText=t?t.label:""}evaluateFinalStates(){let t=[];for(const e of this.graph.nodes)e.label&&e.accept&&t.push(e.label);t.sort(),this.finalStatesElement.innerText=t.join(", ")}onNode(t){this.graph.getInitialState()==t&&this.evaluateStartState(),t.accept&&this.evaluateFinalStates(),this.evaluateStates(),this.evaluateTransitions()}onEdge(t){this.evaluateSymbols(),this.evaluateTransitions()}onEdgeDestination(t,e,s){this.evaluateTransitions()}onNewInitial(t){this.evaluateStartState()}onToggleAccept(t){this.evaluateFinalStates()}parse(){}};const v="#";var y=class{constructor(t,e,s){this.transitions=t,this.startState=e,this.finalStates=s}transition(t,e){let s=[];for(let i of this.transitions)i[0]==t&&i[1]==e&&s.push(i[2]);return s}solve(t){let e=[],s=[];e.push({state:this.startState,index:0});let i=[],o=null,r=null,n=[],h=0;for(;e.length>0;){null!=(r=t.next().value)&&s.push(r);for(let t of e){if(o=t.state,null!=(r=t.index<s.length?s[t.index]:null)){h=t.index+1;for(let t of this.transition(o,r))n.push({state:t,index:h})}else{if(this.finalStates.includes(o))return!0;i.push(o)}h=t.index;for(let t of this.transition(o,v))if(!i.includes(t)){if(null==r&&this.finalStates.includes(t))return!0;n.push({state:t,index:h})}}e.length=0,e.push(...n),n.length=0}return!1}};class x{constructor(t){this.controller=t}activate(){this.controller.cursors.shouldDestroyPointlessEdges=!0}deactivate(){this.controller.cursors.shouldDestroyPointlessEdges=DEFAULT_SHOULD_DESTROY_POINTLESS_EDGE}}var D=class{constructor(t,e,s){this.graph=e,this.mouse=s,this.viewport=t,this.cursors=new E(this.graph,this.mouse),this.buttons=new S(this.viewport,this.graph,this.cursors),this.parser=new T(this.graph),this.mode=new x(this);const i=document.getElementById("test_input"),o=document.getElementById("test_execute");o.addEventListener("click",t=>{alert(this.test((i.value||"")[Symbol.iterator]())?"SUCCESS!":"FAILED!"),i.select()}),i.addEventListener("keyup",t=>{t.keyCode==SUBMIT_KEY&&o.click()})}initialize(){this.cursors.load(),this.buttons.load(),this.mode.activate()}test(t){const e=[];for(const t of this.graph.edges)for(const s of t.label.split(" ")){let i=[];i.push(t.from.label),i.push(s),i.push(t.to?t.to.label:"undefined"),e.push(i)}const s=this.graph.getInitialState().label,i=[];for(const t of this.graph.nodes)t.accept&&i.push(t.label);return new y(e,s,i).solve(t)}update(t){this.cursors.update(t),this.buttons.update(t)}},A=0;class R{onCreate(t,e){}onDestroy(t,e){}onRender(t){}}class I extends R{constructor(t){super(),this.node=t}onRender(t){super.onRender(t);const e=this.node.x,s=this.node.y,i=this.node.label,o=this.node.accept;t.fillStyle=NODE_FILL_STYLE,t.beginPath(),t.arc(e,s,NODE_RADIUS,0,PI2),t.fill(),t.stroke(),o&&(t.beginPath(),t.arc(e,s,NODE_RADIUS_INNER,0,PI2),t.stroke()),t.fillStyle=NODE_TEXT_FILL_STYLE,t.fillText(i,e,s+4)}}class L extends R{constructor(t){super(),this.edge=t}onRender(t){super.onRender(t);this.edge.from,this.edge.to;const e=this.edge.x,s=this.edge.y,i=this.edge.getMidPoint(),o=i[0],r=i[1],n=this.edge.quad,h=this.edge.label;let l=0,c=0,u=0;const g=this.edge.getStartPoint(),d=this.edge.to instanceof a?this.edge.getEndPoint():[this.edge.to.x,this.edge.to.y];if(l=d[0],c=d[1],t.beginPath(),t.moveTo(g[0],g[1]),null==n)u=Math.atan2(g[0]-d[0],g[1]-d[1])+Math.PI,t.lineTo(d[0],d[1]);else{const e=this.edge.getCenterPoint();e[0]+=n.x,e[1]+=n.y,u=Math.atan2(e[0]-d[0],e[1]-d[1])+Math.PI,t.quadraticCurveTo(e[0],e[1],d[0],d[1])}if(t.moveTo(l-ARROW_WIDTH*Math.sin(u-SIXTH_PI),c-ARROW_WIDTH*Math.cos(u-SIXTH_PI)),t.lineTo(l,c),t.lineTo(l-ARROW_WIDTH*Math.sin(u+SIXTH_PI),c-ARROW_WIDTH*Math.cos(u+SIXTH_PI)),t.stroke(),t.closePath(),h.length>0){const i=h.split(" ");let a=0;for(let h of i){let i=0,l=0,c=3*h.length,u=0;null==n?(i=o,l=r):(u=Math.sign(n.y),i=e,l=s+8*u),l+=a*(-u||1),t.clearRect(i-c-2,l-5,2*c+4,10),t.fillText(h,i,l+4),a-=12}}}}class w extends R{constructor(t){super(),this.graph=t}onRender(t){super.onRender(t);const e=this.graph.getInitialState();if(!e)return;const s=e.x,i=e.y;t.strokeStyle=EDGE_STROKE_STYLE,t.beginPath(),t.moveTo(s-NODE_RADIUS,i),t.lineTo(s-NODE_DIAMETER,i-NODE_RADIUS),t.lineTo(s-NODE_DIAMETER,i+NODE_RADIUS),t.closePath(),t.stroke()}}class O extends R{constructor(t){super(),this.selectBox=t}onRender(t){super.onRender(t);const e=this.selectBox.mx-this.selectBox.x,s=this.selectBox.my-this.selectBox.y;t.save(),t.shadowColor=SELECTION_BOX_SHADOW_COLOR,t.shadowBlur=SELECTION_BOX_SHADOW_SIZE,t.shadowOffsetX=SELECTION_BOX_SHADOW_OFFSETX,t.shadowOffsetY=SELECTION_BOX_SHADOW_OFFSETY,t.fillStyle=SELECTION_BOX_FILL_STYLE,t.strokeStyle=SELECTION_BOX_STROKE_STYLE,t.fillRect(this.selectBox.x,this.selectBox.y,e,s),t.strokeRect(this.selectBox.x,this.selectBox.y,e,s),t.restore()}}class b extends R{constructor(t){super(),this.controller=t}onRender(t){super.onRender(t);const e=this.controller.cursors.hoverTarget,s=this.controller.cursors.hoverType;if(null==e)return;if(this.controller.cursors.selectCursor.selectBox.targets.includes(e))return;let i=0,o=0,r=CURSOR_RADIUS;switch(s){case"node":i=e.x,o=e.y,r=NODE_RADIUS;break;case"edge":i=e.x,o=e.y,r=EDGE_RADIUS;break;case"endpoint":const t=e.getEndPoint();i=t[0],o=t[1],r=ENDPOINT_RADIUS;break;default:i=i,o=o}t.save();{const e=A;t.strokeStyle=HOVER_STROKE_STYLE,t.lineWidth=HOVER_LINE_WIDTH,t.beginPath(),t.setLineDash(HOVER_LINE_DASH),t.arc(i,o,r+HOVER_RADIUS_OFFSET,0+e,PI2+e),t.stroke()}t.restore(),A=(A+HOVER_ANGLE_SPEED)%PI2}}class M extends R{constructor(t,e){super(),this.target=t,this.type=e}onRender(t){super.onRender(t);const e=this.target,s=this.type;let i=0,o=0,r=CURSOR_RADIUS;switch(s){case"node":i=e.x,o=e.y,r=NODE_RADIUS;break;case"edge":i=e.x,o=e.y,r=EDGE_RADIUS;break;case"endpoint":const t=e.getEndPoint();i=t[0],o=t[1],r=ENDPOINT_RADIUS;break;default:i=i,o=o}t.save();{const e=A;t.strokeStyle=HOVER_STROKE_STYLE,t.lineWidth=HOVER_LINE_WIDTH,t.beginPath(),t.setLineDash(HOVER_LINE_DASH),t.arc(i,o,r+HOVER_RADIUS_OFFSET,0+e,PI2+e),t.stroke()}t.restore()}}class N extends R{constructor(t){super(),this.trashArea=t}onRender(t){super.onRender(t),t.shadowColor=TRASH_AREA_SHADOW_COLOR,t.shadowBlur=TRASH_AREA_SHADOW_SIZE,t.shadowOffsetX=TRASH_AREA_SHADOW_OFFSETX,t.shadowOffsetY=TRASH_AREA_SHADOW_OFFSETY,t.fillStyle=TRASH_AREA_FILL_STYLE,t.strokeStyle=TRASH_AREA_STROKE_STYLE,t.fillRect(this.trashArea.x,this.trashArea.y,this.trashArea.width,this.trashArea.height),t.strokeRect(this.trashArea.x,this.trashArea.y,this.trashArea.width,this.trashArea.height)}}var C=class{constructor(t,e,s,i){this.ctx=t,this.canvas=e,this.graph=s,this.controller=i,this.nodeElements=new Map,this.edgeElements=new Map,this.selectElements=new Map,this.initialMarkerElement=new w(this.graph),this.initialMarkerElement.onCreate(this.ctx,this.canvas),this.selectionBoxElement=new O(this.controller.cursors.selectCursor.selectBox),this.selectionBoxElement.onCreate(this.ctx,this.canvas),this.hoverElement=new b(this.controller),this.hoverElement.onCreate(this.ctx,this.canvas),this.trashAreaElement=new N(this.controller.cursors.trashArea),this.trashAreaElement.onCreate(this.ctx,this.canvas),this.graph.on("nodeCreate",t=>{const e=new I(t);e.onCreate(this.ctx,this.canvas),this.nodeElements.set(t,e)}),this.graph.on("nodeDestroy",t=>{this.nodeElements.get(t).onDestroy(this.ctx,this.canvas),this.nodeElements.delete(t)}),this.graph.on("edgeCreate",t=>{const e=new L(t);e.onCreate(this.ctx,this.canvas),this.edgeElements.set(t,e)}),this.graph.on("edgeDestroy",t=>{this.edgeElements.get(t).onDestroy(this.ctx,this.canvas),this.edgeElements.delete(t)})}render(t){t.save(),t.font=EDGE_FONT,t.textAlign=EDGE_TEXT_ALIGN,t.strokeStyle=EDGE_STROKE_STYLE;for(const[e,s]of this.edgeElements)s.onRender(t);t.restore(),t.save(),this.initialMarkerElement.onRender(t),t.restore(),t.save(),t.font=NODE_FONT,t.textAlign=NODE_TEXT_ALIGN,t.strokeStyle=NODE_STROKE_STYLE,t.fillStyle=NODE_FILL_STYLE;for(const[e,s]of this.nodeElements)s.onRender(t);if(t.restore(),t.save(),this.controller.cursors.selectCursor.hasSelection()){let e=this.controller.cursors.selectCursor.getSelection(this.controller.cursors.cursor);for(const t of e)this.selectElements.has(t)||this.selectElements.set(t,new M(t,"node"));let s=[];for(const[i,o]of this.selectElements)e.includes(i)?o.onRender(t):s.push(i);for(const t of s){const e=this.selectElements.get(t);e.onDestroy(this.ctx,this.canvas),this.selectElements.delete(e)}}t.restore(),t.save(),this.controller.cursors.selectCursor.isSelecting&&this.selectionBoxElement.onRender(t),this.hoverElement.onRender(t),t.restore(),t.save(),this.trashAreaElement.onRender(t),t.restore(),A=(A+HOVER_ANGLE_SPEED)%PI2}};const P=document.getElementById("canvas"),B=P.getContext("2d"),H=new n(P,document),U=60;window.addEventListener("load",t=>{P.width=window.innerWidth,P.height=window.innerHeight,function(){let t=null,e=null,s=null;t=Y.createNewNode(-64,0,"q0"),(e=Y.createNewNode(64,0,"q1")).accept=!0,s=Y.createNewEdge(t,e,"0 1"),X.initialize()}(),window.requestAnimationFrame(F)}),window.addEventListener("resize",t=>{P.width=window.innerWidth,P.height=window.innerHeight});const Y=new h(P),X=new D(P,Y,H),k=new C(B,P,Y,X);let q=0;function F(t){const e=(t-q)/U;B.clearRect(0,0,P.width,P.height),Y.update(e),X.update(e),k.render(B),q=t,window.requestAnimationFrame(F)}}]);